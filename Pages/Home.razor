@page "/"

@using MegaSenaBlazor.Models
@using MegaSenaBlazor.Services

@inject LocalStorageService LocalStorageService

@inject MegaSenaService MegaSenaService
@inject IJSRuntime JS

<div class="container">
    <audio id="plimSound" src="sounds/plim.mp3" preload="auto"></audio>
    <h2>Gerador da Sorte 🍀</h2>
    <h4>Último Resultado da Mega-Sena</h4>

    @if (isLoadingApi)
    {
        <div class="loading-area">
            <div class="clover-loading-group">
                @for (int i = 0; i < 6; i++)
                {
                    <div class="clover-small">🍀</div>
                }
            </div>
            <div class="loading-message">Buscando último sorteio...</div>
        </div>
    }
    else if (latestResult is not null)
    {
        <div class="result-detail">
            <p><strong>Concurso:</strong> @latestResult.DrawNumber</p>
            <p><strong>Data:</strong> @latestResult.Date</p>

            <div class="numbers">
                @foreach (var number in latestResult.Numbers.OrderBy(n => n))
                {
                    <div class="number-ball">@number</div>
                }
            </div>

            <p><strong>Acumulou:</strong>
                <span style="color:@(latestResult.IsAccumulated ? "green" : "red"); font-weight:bold;">
                    @(latestResult.IsAccumulated ? "SIM" : "NÃO")
                </span>
            </p>

            <p><strong>Próximo Sorteio:</strong> @latestResult.NextDrawDate</p>

            <p><strong>Valor Acumulado:</strong> @FormatPrize(latestResult.NextAccumulatedDrawPrize)</p>
            <p><strong>Valor Estimado do @latestResult.DrawNumber:</strong> @FormatPrize(latestResult.NextDrawPrize)</p>
        </div>
    }

    <div class="section">
        <h4>Gerador de Números</h4>

        @if (isGenerating)
        {
            <div class="clover-loading-group">
                @for (int i = 0; i < 6; i++)
                {
                    <div class="clover-small">🍀</div>
                }
            </div>
        }
        else if (generatedNumbers.Count > 0)
        {
            <div class="numbers">
                @foreach (var number in revealedNumbers)
                {
                    <div class="number-ball generated-ball">@number</div>
                }
            </div>
        }

        <div style="text-align:center; margin-top: 1rem;">
            <button @onclick="GenerateNumbers" disabled="@isGenerating">Gerar</button>
        </div>
    </div>

    @if (generatedNumbers.Count == 6)
    {
        <div style="text-align:center; margin-top:0.5rem;">
            <button @onclick="SaveGeneratedGame">Salvar jogo</button>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(saveMessage))
    {
        <p style="text-align:center; color:green; font-weight:bold;">@saveMessage</p>
    }

    <div style="text-align:center; margin-top: 2rem;">
        <button @onclick="LoadSavedGames">Ver jogos salvos</button>
    </div>

    <div class="section">
        <div class="section">
            <button @onclick="OpenLastResultsModal">Ver últimos 5 resultados</button>
        </div>

        @if (showModal)
        {
            <div class="modal-backdrop" @onclick="CloseModal">
                <div class="modal-content" @onclick:stopPropagation>
                    <h2>Últimos 5 Resultados</h2>

                    @if (isLoadingApi)
                    {
                        <div class="clover-loading-group">
                            @for (int i = 0; i < 6; i++)
                            {
                                <div class="clover-small">🍀</div>
                            }
                        </div>
                    }
                    else
                    {
                        @foreach (var result in lastFiveResults)
                        {
                            <div class="result-detail">
                                <p><strong>Concurso:</strong> @result.DrawNumber (@result.Date)</p>
                                <div class="numbers">
                                    @foreach (var n in result.Numbers.OrderBy(n => n))
                                    {
                                        <div class="number-ball">@n</div>
                                    }
                                </div>
                            </div>
                        }
                    }

                    <div style="text-align:center; margin-top:1rem;">
                        <button @onclick="CloseModal">Fechar</button>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (showSavedGamesModal)
{
    <div class="modal-overlay" @onclick="() => showSavedGamesModal = false">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Jogos Salvos 🍀</h2>
                <button class="close-btn" @onclick="() => showSavedGamesModal = false">❌</button>
            </div>

            @if (savedGames.Count == 0)
            {
                <p>Nenhum jogo salvo ainda.</p>
            }
            else
            {
                <ul>
                    @foreach (var game in savedGames.OrderByDescending(g => g.CreatedAt))
                    {
                        <li style="margin-bottom: 1rem;">
                            <strong>@game.CreatedAt.ToString("dd/MM/yyyy HH:mm"):</strong><br />
                            @string.Join(", ", game.Numbers.OrderBy(n => n))
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
}
</div>

@code {
    private List<int> generatedNumbers = new();
    private MegaSenaResult? latestResult;
    private bool isLoadingApi = true;
    private bool isGenerating = false;
    private List<int> revealedNumbers = new();

    private List<MegaSenaResult> lastFiveResults = new();
    private bool showModal = false;

    private string? saveMessage;
    private bool showSavedGamesModal = false;
    private List<SavedGame> savedGames = new();

    private async Task GenerateNumbers()
    {
        isGenerating = true;
        revealedNumbers.Clear();

        await Task.Delay(600);

        var rand = new Random();
        generatedNumbers = Enumerable
        .Range(1, 60)
        .OrderBy(_ => rand.Next())
        .Take(6)
        .ToList();

        foreach (var number in generatedNumbers.OrderBy(n => n))
        {
            revealedNumbers.Add(number);
            await JS.InvokeVoidAsync("playPlim");
            StateHasChanged();
            await Task.Delay(400);
        }

        isGenerating = false;
    }

    protected override async Task OnInitializedAsync()
    {
        isLoadingApi = true;
        latestResult = await MegaSenaService.GetLatestResultAsync();
        isLoadingApi = false;
    }

    private string FormatPrize(double prize)
    {
        return prize.ToString("C2", new System.Globalization.CultureInfo("pt-BR"));
    }

    private async Task OpenLastResultsModal()
    {
        showModal = true;

        if (lastFiveResults.Count == 0)
        {
            isLoadingApi = true;
            lastFiveResults = await MegaSenaService.GetLastResultsAsync(5);
            isLoadingApi = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SaveGeneratedGame()
    {
        if (generatedNumbers.Count == 6)
        {
            var game = new SavedGame
            {
                Numbers = new List<int>(generatedNumbers),
                CreatedAt = DateTime.Now
            };

            await LocalStorageService.SaveGameAsync(game);
            saveMessage = "Jogo salvo com sucesso! 🍀";
        }
    }

    private async Task LoadSavedGames()
    {
        savedGames = await LocalStorageService.GetSavedGamesAsync();
        showSavedGamesModal = true;
    }
}
